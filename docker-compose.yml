services:
  # PostgreSQL Database
  db:
    image: postgres:15-alpine
    container_name: miq2-db
    environment:
      POSTGRES_DB: miq2
      POSTGRES_USER: miq2
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U miq2 -d miq2"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - miq2-network

  # Redis para cache (Evolution API)
  redis:
    image: redis:latest
    container_name: miq2-redis
    restart: always
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - miq2-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Evolution API para WhatsApp
  evolution-api:
    image: evoapicloud/evolution-api:latest
    container_name: miq2-evolution
    restart: always
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "8080:8080"
    volumes:
      - evolution_instances:/evolution/instances
    networks:
      - miq2-network
    environment:
      # Servidor
      SERVER_NAME: miq2-evolution
      SERVER_TYPE: http
      SERVER_PORT: 8080
      SERVER_URL: ${EVOLUTION_SERVER_URL:-http://localhost:8080}
      
      # Banco de dados (usa o mesmo PostgreSQL, schema separado)
      DATABASE_PROVIDER: postgresql
      DATABASE_CONNECTION_URI: postgresql://miq2:${POSTGRES_PASSWORD}@db:5432/miq2?schema=evolution
      DATABASE_CONNECTION_CLIENT_NAME: evolution
      DATABASE_SAVE_DATA_INSTANCE: "true"
      DATABASE_SAVE_DATA_NEW_MESSAGE: "true"
      DATABASE_SAVE_MESSAGE_UPDATE: "true"
      DATABASE_SAVE_DATA_CONTACTS: "true"
      DATABASE_SAVE_DATA_CHATS: "true"
      DATABASE_SAVE_DATA_LABELS: "true"
      DATABASE_SAVE_DATA_HISTORIC: "true"
      
      # Cache Redis
      CACHE_REDIS_ENABLED: "true"
      CACHE_REDIS_URI: redis://redis:6379/0
      CACHE_REDIS_PREFIX_KEY: evolution
      CACHE_LOCAL_ENABLED: "false"
      
      # Autenticação
      AUTHENTICATION_API_KEY: ${EVOLUTION_API_KEY}
      AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES: "true"
      
      # Logs
      LOG_LEVEL: ERROR,WARN,INFO
      LOG_COLOR: "true"
      LOG_BAILEYS: error
      
      # CORS
      CORS_ORIGIN: "*"
      CORS_METHODS: GET,POST,PUT,DELETE
      CORS_CREDENTIALS: "true"
      
      # Webhook (aponta para backend Miq2 via rede interna)
      WEBHOOK_GLOBAL_ENABLED: "true"
      WEBHOOK_GLOBAL_URL: http://backend:8000/chat/webhook
      WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS: "false"
      WEBHOOK_EVENTS_MESSAGES_UPSERT: "true"
      WEBHOOK_EVENTS_MESSAGES_UPDATE: "true"
      WEBHOOK_EVENTS_MESSAGES_DELETE: "true"
      WEBHOOK_EVENTS_SEND_MESSAGE: "true"
      WEBHOOK_EVENTS_CONNECTION_UPDATE: "true"
      WEBHOOK_EVENTS_QRCODE_UPDATED: "true"
      WEBHOOK_EVENTS_CONTACTS_UPSERT: "true"
      WEBHOOK_EVENTS_CONTACTS_UPDATE: "true"
      WEBHOOK_EVENTS_CHATS_UPSERT: "true"
      WEBHOOK_EVENTS_CHATS_UPDATE: "true"
      WEBHOOK_EVENTS_PRESENCE_UPDATE: "true"
      
      # WebSocket
      WEBSOCKET_ENABLED: "true"
      WEBSOCKET_GLOBAL_EVENTS: "false"
      
      # Integrações (desabilitadas - usamos nosso próprio chatbot)
      TYPEBOT_ENABLED: "false"
      CHATWOOT_ENABLED: "false"
      OPENAI_ENABLED: "false"
      DIFY_ENABLED: "false"
      
      # Instâncias
      DEL_INSTANCE: "false"
      QRCODE_LIMIT: 30
      QRCODE_COLOR: "#175197"

  # Backend API
  backend:
    build: ./backend
    container_name: miq2-backend
    environment:
      DATABASE_URL: postgresql://miq2:${POSTGRES_PASSWORD}@db:5432/miq2
      SECRET_KEY: ${SECRET_KEY}
      DEBUG: "true"
      CORS_ORIGINS: '["http://localhost:3000", "http://localhost:5173", "http://localhost:8080"]'
      # Evolution API
      EVOLUTION_API_URL: http://evolution-api:8080
      EVOLUTION_API_KEY: ${EVOLUTION_API_KEY}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
      evolution-api:
        condition: service_started
    volumes:
      - ./backend:/app
    command: sh -c "python seed.py && uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload"
    networks:
      - miq2-network

  # Frontend (React)
  frontend:
    build: ./frontend
    container_name: miq2-frontend
    ports:
      - "3000:3000"
    depends_on:
      - backend
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - VITE_API_URL=http://localhost:8000
      - VITE_EVOLUTION_API_URL=http://localhost:8080
    networks:
      - miq2-network

volumes:
  postgres_data:
  redis_data:
  evolution_instances:

networks:
  miq2-network:
    driver: bridge
